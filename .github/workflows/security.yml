# THALE Security Scanning
# Runs vulnerability scans on dependencies and container images

name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF results

jobs:
  # Python dependency security scan
  python-security:
    name: Python Dependencies (pip-audit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install pip-audit
        run: pip install pip-audit
      
      - name: Run pip-audit
        run: |
          echo "## Python Security Scan (pip-audit)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pip-audit -r requirements.txt --desc --format markdown >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Vulnerabilities found - see details above" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true  # Don't fail the workflow, just report
  
  # JavaScript dependency security scan
  npm-security:
    name: NPM Dependencies (npm audit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: |
          echo "## NPM Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --production --audit-level=moderate || echo "âš ï¸ Vulnerabilities found - run 'npm audit' locally for details" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true  # Don't fail the workflow, just report
  
  # Backend container security scan
  trivy-backend:
    name: Backend Container (Trivy)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build backend image for scanning
        run: |
          docker build \
            -f backend/Dockerfile \
            -t thale-backend:${{ github.sha }} \
            backend/
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2
        with:
          image-ref: 'thale-backend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'backend-container'
      
      - name: Run Trivy for PR summary
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2
        if: github.event_name == 'pull_request'
        with:
          image-ref: 'thale-backend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true
  
  # Frontend container security scan
  trivy-frontend:
    name: Frontend Container (Trivy)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build frontend image for scanning
        run: |
          docker build \
            -t thale-frontend:${{ github.sha }} \
            frontend/
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2
        with:
          image-ref: 'thale-frontend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend-container'
      
      - name: Run Trivy for PR summary
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2
        if: github.event_name == 'pull_request'
        with:
          image-ref: 'thale-frontend:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true
  
  # Security summary
  security-summary:
    name: Security Summary
    needs: [python-security, npm-security, trivy-backend, trivy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ›¡ï¸ THALE Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Dependencies | ${{ needs.python-security.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Dependencies | ${{ needs.npm-security.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Container | ${{ needs.trivy-backend.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Container | ${{ needs.trivy-frontend.result == 'success' && 'âœ… Pass' || 'âš ï¸ Review needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
